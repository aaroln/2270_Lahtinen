<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CODE2270 - A LAHTINEN</title>
    <meta
        name="viewport"
        content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
  <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300&display=swap" rel="stylesheet">

</head>

<body>

<div class="titleBlock" style=background:white>
    <h1>BIM INTERFACE</h1>
    <section class="header">
        <nav>
            <div class="nav-links">
                <ul>
                    <li><a href="">Viewport</a></li>
                    <li><a href="">Plans</a></li>
                    <li><a href="">Sections</a></li>
                    <li><a href="">Renders</a></li>
                    <li><a href="">Schedules</a></li>
                </ul>
            </div>
        </nav>
    </section>
</div>

<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1223.0.js"></script>
<script src="/loadS3.js"></script>
<script>listFiles();</script>
<script src="/js/three.js"></script>
<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.138.3/build/three.module.js"
        }
    }
</script>


<div class="canvas">
    <div id="frame"></div>
    <script type="module">

    import * as THREE from 'three';
    import { OrbitControls } from 'https://unpkg.com/three@0.138.3/examples/jsm/controls/OrbitControls.js';
    import { IFCLoader } from 'https://unpkg.com/three@0.138.3/examples/jsm/loaders/IFCLoader.js';

    // Getting dimensions of div ID "frame"
    let box = document.querySelector('.canvas');
    let width = box.clientWidth;
    let height = box.clientHeight
    const container = document.getElementById('frame');

    // Scene setup
    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera( 75, width / height, 1, 10000 );

    // Renderer
    const renderer = new THREE.WebGLRenderer( { antialias: true } );
    renderer.setPixelRatio ( window.devicePixelRatio );
    renderer.setSize( width, height );
    container.appendChild( renderer.domElement )

    //Lights
    const light = new THREE.DirectionalLight( 'white', 0.1 );
    light.position.set( 0, 10, 0 ); //default; light shining from top
    light.castShadow = true; // default false
    scene.add( light );


    const ambientLight = new THREE.AmbientLight('white', 0.8 );
    scene.add( ambientLight );

    // Scene
    scene.background = new THREE.Color('aliceblue')
    camera.position.z = 15;
    camera.position.y = 5;
    camera.position.x = -10;

    // Setup IFC Loader
    const ifcLoader = new IFCLoader();
    ifcLoader.ifcManager.setWasmPath('./model/');
    ifcLoader.load('model/viewport.ifc', function (model) {

        scene.add(model.mesh);
        render();
    });

    const highlightMaterial = new THREE.MeshPhongMaterial( { color: 'blue', depthTest: false, transparent: true, opacity: 0.1 } );

    function selectObject( event ) {

        if ( event.button != 0 ) return;

        const mouse = new THREE.Vector2();
        mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
        mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera( mouse, camera );

        const intersected = raycaster.intersectObjects( scene.children, false );
        if ( intersected.length ) {

            const found = intersected[ 0 ];
            const faceIndex = found.faceIndex;
            const geometry = found.object.geometry;
            const id = ifcLoader.ifcManager.getExpressId( geometry, faceIndex );

            const modelID = found.object.modelID;
            ifcLoader.ifcManager.createSubset( { modelID, ids: [ id ], scene, removePrevious: true, material: highlightMaterial } );
            const props = ifcLoader.ifcManager.getItemProperties( modelID, id, true );
            console.log( props );
            renderer.render( scene, camera );

        }

    }

    window.onpointerdown = selectObject;

    //Controls
    const controls = new OrbitControls( camera, renderer.domElement );
    controls.addEventListener( 'change', render );

    render();

    function render() {

        renderer.render( scene, camera );

    }

    </script>
</div>

</body>
</html>